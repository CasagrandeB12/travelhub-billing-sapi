<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<error-handler name="global-error-handler">
		<on-error-propagate type="APIKIT:BAD_REQUEST"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="4f5b3a40-c2fe-4c59-ae3e-abc023b06ea8">
			<set-variable value="#[400]"
				doc:name="Set HTTP Status - 400"
				doc:id="65a6f1fa-ab50-4cb2-95f0-894b5786bced"
				variableName="httpStatus" />
			<set-variable value='Bad request'
				doc:name="set Error Message"
				doc:id="7b932433-3d90-4573-9f57-6a70363e307c"
				variableName="errorMessage" />
			<set-variable value='#[error.description default ""]'
				doc:name="Set Error Description"
				doc:id="b06b4262-a8bb-489b-b8af-cdfd75495fb0"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="51e60398-4621-4aa5-aa74-ed30c1a19aa0"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="526e8e10-e3f6-43c7-a4c4-cf35adf4aa7b">
			<set-variable value="#[405]"
				doc:name="Set HTTP Status - 405"
				doc:id="204bdc95-5758-4d6a-9ff0-bf1c1b11c420"
				variableName="httpStatus" />
			<set-variable value='Method Not Allowed'
				doc:name="Set Error Message"
				doc:id="5936e1ce-5598-4633-99e8-1b0eb101a0a3"
				variableName="errorMessage" />
			<set-variable
				value="The method specified in the request is not allowed for this resource"
				doc:name="Set Error Description"
				doc:id="f1cd9f93-b677-4ea2-b85f-40c9fde9d5ff"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="ca73ce8d-54e8-446d-988c-d3a53a1fba20"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_ACCEPTABLE"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="82c0a423-07e9-48ba-8c82-3d7f1238266b">
			<set-variable value="#[406]"
				doc:name="Set HTTP Status - 406"
				doc:id="dc5892ca-dff0-4113-bfa7-ce37c1517b35"
				variableName="httpStatus" />
			<set-variable value="Not Acceptable"
				doc:name="Set Error Message"
				doc:id="93974be7-a2b1-4804-8c5c-dd77f53c4dac"
				variableName="errorMessage" />
			<set-variable
				value="The resource identified by the request is not capable of generating response entities according to the request accept headers"
				doc:name="Set Error Description"
				doc:id="4c3a7d54-30ba-472f-b861-43a1a537e29a"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="041d328f-2fba-4e9c-b472-c06a2506dbf9"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_FOUND"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="dde2e246-8dde-48c9-9d02-45c70f2b79e3">
			<set-variable value="#[404]"
				doc:name="Set HTTP Status - 404"
				doc:id="017405b8-5302-4fa1-8043-7afd0056f9fc"
				variableName="httpStatus" />
			<set-variable value="Not found"
				doc:name="Set Error Message"
				doc:id="6d64cbac-ac22-459b-be43-6a52d13a51de"
				variableName="errorMessage" />
			<set-variable
				value="The server has not found anything matching the Request-URI"
				doc:name="Set Error Description"
				doc:id="fa9a959b-9dfd-47ec-8b5a-493592ec0786"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="0268e0e4-970f-41f1-b7f0-970e84f75bf3"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="44d775a6-bfb3-4f34-bd49-df5cb320c2b6">
			<set-variable value="#[415]"
				doc:name="Set HTTP Status - 415"
				doc:id="a67d94b5-5d83-4e65-a91d-10c6f6d0ea3c"
				variableName="httpStatus" />
			<set-variable value="Unsupported media type"
				doc:name="Set Error Message"
				doc:id="d7259a3a-6592-4b73-a5ed-a9c71bd5ec40"
				variableName="errorMessage" />
			<set-variable
				value="The server is refusing to service the request because the entity of the request is in a format not supported by the requested resource for the requested method"
				doc:name="Set Error Description"
				doc:id="902a512a-333d-49ec-be65-6dc6f49db380"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="72e5ede7-2401-4708-8e06-845163c2fa60"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_IMPLEMENTED">
			<set-variable value="#[501]"
				doc:name="Set HTTP Status - 501"
				doc:id="667bd541-be18-40b2-a19f-8a463359adde"
				variableName="httpStatus" />
			<set-variable value="Not Implemented"
				doc:name="Set Error Message"
				doc:id="d4b0b0c1-f04b-4ee0-895d-592c7836a3a4"
				variableName="errorMessage" />
			<set-variable
				value="The requested resource is not implemented"
				doc:name="Set Error Description"
				doc:id="1fe7b894-378e-4040-9a79-2021ec87cfff"
				variableName="errorDescription" />
			<ee:transform
				doc:name="global-prepare-error-response-sub-flow">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not Implemented"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">501</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="885f4568-82dc-4ed4-86f3-3ed7a8aea264" type="JMS:PUBLISHING">
			<set-variable value="#[400]"
				doc:name="Set HTTP Status - 400"
				doc:id="e2b2c287-b92b-4e0c-baea-949d17a3b338"
				variableName="httpStatus" />
			<set-variable value="Bad Request"
				doc:name="Set Error Message"
				doc:id="08a55bdb-3ed3-4d59-a8bc-dadf99905364"
				variableName="errorMessage" />
			<set-variable value="#[error.errorMessage]"
				doc:name="Set Error Description"
				doc:id="1d0af7c9-7a19-4d0f-850b-82590203ac08"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="aaa0b00c-9780-4cc3-97e9-532a51739f0f"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="8136ce46-ee5d-44fd-8908-c0c5e426b2ba" type="ANY">
			<set-variable value="#[500]"
				doc:name="Set HTTP Status - 500"
				doc:id="55940910-9fca-4d51-b57d-ade18d6ed455"
				variableName="httpStatus" />
			<set-variable value="Internal Server Error"
				doc:name="Set Error Message"
				doc:id="04440957-8764-4118-b5be-8ae4052795c1"
				variableName="errorMessage" />
			<set-variable value="#[error.errorMessage]"
				doc:name="Set Error Description"
				doc:id="9e60cb84-e9d4-484f-88b0-028b99e9d6c1"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="c20f0319-9570-45c1-8d7e-2be4d944990d"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
	</error-handler>
	<sub-flow name="global-prepare-error-response-sub-flow"
		doc:id="3f752f2e-d793-481d-869c-29cee643723b">
		<ee:transform doc:name="Init Variables"
			doc:id="f31750bf-fad9-4bc4-b1ea-692f2c51136f">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="errorRaised"><![CDATA[%dw 2.0
output application/java
---
true]]></ee:set-variable>
				<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
output application/java
---
if(vars.errorDescription?) 
	vars.errorDescription 
else 
	error.exception.detailMessage]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Error Response"
			doc:id="8a6f2dcf-221a-4656-ba41-bd7434bd6c1d">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json encoding="UTF-8", skipNullOn="everywhere"
---
{
	code : vars.httpStatus,
	message : if(vars.errorMessage != null) vars.errorMessage else (error.errorType.identifier),
	description: if(vars.errorDescription != null) vars.errorDescription else error.description,
	dateTime : now() as String { format: "yyyy-MM-dd'T'HH:mm:ss'Z'" },
	correlationId: vars.correlationId,
	transactionId : vars.transactionId
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="ERROR" doc:name="Error Logger"
			doc:id="043ca38e-0393-462a-aa73-36fb6874e2c2"
			message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	"correlationId": vars.correlationId,&#10;	"transactionId": vars.transactionId,&#10;	"errorCode": vars.httpStatus,&#10;	"errorMessage": error.errorType.identifier default "",&#10;	"errorDescription": error.description default ""&#10;}]' />
	</sub-flow>

</mule>
